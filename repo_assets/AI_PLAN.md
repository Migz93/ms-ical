# plan.md — “MS Family Calendar → Local iCal Publisher” (Node + Docker)

Below you will find the plan for the project that was generated by ChatGPT and then fed to Windsurf/Claude Sonnet 4.5 to actually create.
Many further changes were made beyond the below directly in Windsurf.

## Goal
Build a **self-hosted** web app (Docker) that:
- Lets me connect to a Microsoft account (OAuth sign-in) and read calendars via Microsoft Graph.
- Lets me **select one or more calendars** (including “Your Family” if Graph exposes it in the account).
- Shows a **web calendar UI** (month/week/day) for the selected calendars.
- Publishes selected calendars as **local-only iCal (.ics) URLs** that other local software can consume.
- Provides a **Settings** page for credentials + a **Test connection** button.
- Shows the **generated iCal feed URL(s)** in the UI.

> Context: Outlook.com “Your Family” calendar has no built-in iCal publishing link. There are Microsoft community threads asking for it. :contentReference[oaicite:0]{index=0}

---

## Non-goals
- No write support (creating/editing events) in v1.
- No multi-tenant enterprise admin consent flows (keep it simple).
- No public internet hosting required.

---

## Key constraints & notes
- Microsoft Graph calendar access uses OAuth scopes/permissions (delegated permissions for a user sign-in). :contentReference[oaicite:1]{index=1}
- Graph supports reading calendar data from a user mailbox in Exchange Online/Outlook.com. :contentReference[oaicite:2]{index=2}
- “Your Family” calendar availability via Graph is not guaranteed; the app must **discover calendars dynamically** and gracefully handle when it’s not present.

---

## Tech stack (Node-only backend; web UI included)
**Backend**
- Node.js 20+
- Express (REST API + ICS endpoints)
- MSAL Node (Microsoft Authentication Library) for OAuth
- Microsoft Graph SDK (or plain fetch) for Graph calls
- SQLite (better-sqlite3) for persistence
- zod for validation
- pino for logging

**Frontend**
- React (Vite) OR Next.js (single repo)
- FullCalendar (month/week/day UI)
- Simple settings wizard + calendar selector
- Tailwind (optional)

**Container**
- Dockerfile + docker-compose.yml
- Persist SQLite DB to a volume

---

## Authentication model
### Option A (recommended): Delegated OAuth (sign-in as the user)
- Use **Authorization Code Flow** (confidential client).
- Request scopes:
  - `openid profile email`
  - `offline_access` (refresh token so the app can keep syncing)
  - `Calendars.Read` (read calendar events) :contentReference[oaicite:3]{index=3}

### Why delegated
- This is a home/self-host scenario; signing in as the user is simplest.
- “Application permissions” are more complex and often require admin consent (avoid in v1).

---

## UX / Pages
### 1) Main page: Calendar view
- Shows a FullCalendar view with:
  - Month / Week / Day / Agenda
  - Toggle for enabled calendars (from “selected” set)
  - Colour per calendar
- Pull events from backend `/api/events?from=...&to=...&calIds=...`

### 2) Settings page
Sections:
1. **Microsoft App Registration**
   - Client ID
   - Tenant setting: “common” or “consumers” (start with `consumers`)
   - Client Secret (or store in env var only; UI can optionally set it and persist encrypted)
   - Redirect URI (display what to set in Azure portal)
2. **Auth**
   - “Sign in with Microsoft” button
   - “Test connection” button:
     - calls `/api/test` → attempts `GET /me` and list calendars
3. **Calendar selection**
   - List calendars discovered from Graph
   - Multi-select calendars to:
     - show on main page
     - publish as iCal feeds
4. **Local feed URLs**
   - For each published feed show:
     - Name
     - URL (copy button)
     - “Regenerate token” button

---

## Functional requirements
### Calendar discovery
- Fetch calendars via Graph:
  - `GET /me/calendars`
  - Also consider listing calendar groups if needed:
    - `GET /me/calendarGroups` then `GET /me/calendarGroups/{id}/calendars`
- Display:
  - calendar name
  - owner (if available)
  - canRead (always true if returned)
  - inferred type: personal/shared/unknown

### Event fetching (for UI)
- Use calendarView endpoints for date windows:
  - `GET /me/calendars/{calId}/calendarView?startDateTime=...&endDateTime=...`
- Normalize to:
  - id, subject, start, end, isAllDay, location, bodyPreview (optional)
- Cache lightly (in-memory per request window) to reduce API calls.

### iCal feed generation
- Provide endpoints like:
  - `GET /ical/:token.ics`
- Token maps to one feed config:
  - selected calendar IDs (one or many)
  - name
  - timezone preference
- Generate ICS on the fly:
  - Pull events for a configurable range:
    - past: 30 days
    - future: 365 days
  - Convert to ICS using a library:
    - `ical-generator` or `ics` (evaluate which is cleaner)
- Response headers:
  - `Content-Type: text/calendar; charset=utf-8`
  - `Cache-Control: max-age=300` (5 min)
  - `ETag` support (optional)

---

## Security requirements (LAN-friendly)
- Default bind: `0.0.0.0` in Docker but intended behind LAN / reverse proxy.
- Protect settings endpoints with an admin password (optional but recommended):
  - `ADMIN_PASSWORD` env var
  - Simple cookie session after login
- iCal feeds:
  - Tokenized URLs (unguessable, 32+ bytes random)
  - Ability to revoke/regenerate token
- Store secrets:
  - Prefer secrets via env vars:
    - `MS_CLIENT_ID`
    - `MS_CLIENT_SECRET`
    - `MS_AUTHORITY` (`https://login.microsoftonline.com/consumers` or `common`)
    - `BASE_URL` for generating feed URLs
  - If allowing UI entry, encrypt at rest using `ENCRYPTION_KEY` env var.

---

## Data model (SQLite)
### tables
**settings**
- id (1)
- ms_client_id (text)
- ms_client_secret_enc (text, nullable if env-only)
- ms_authority (text)
- redirect_uri (text)
- updated_at (datetime)

**tokens**
- id (pk)
- account_home_id (text) — MSAL account identifier
- access_token_enc (text, optional if using MSAL cache)
- refresh_token_enc (text) — if not using MSAL built-in cache
- expires_at (datetime)
- updated_at (datetime)

**feeds**
- id (pk)
- name (text)
- token (text, unique)
- calendar_ids_json (text)
- include_past_days (int)
- include_future_days (int)
- timezone (text)
- enabled (int)
- created_at (datetime)
- updated_at (datetime)

**ui_state**
- id (pk)
- selected_calendar_ids_json (text)
- last_view (text)
- updated_at (datetime)

> Implementation note: MSAL can manage token caching. If so, store MSAL cache blob in SQLite or a file volume and avoid hand-rolling refresh tokens.

---

## API design
### Auth
- `GET /auth/login` → redirects to Microsoft login
- `GET /auth/callback` → completes flow, stores account in MSAL cache, redirects to app
- `POST /auth/logout`

### Settings
- `GET /api/settings` (masked secrets)
- `POST /api/settings` (validate, persist)
- `POST /api/test` (calls Graph `/me` + list calendars)

### Calendars
- `GET /api/calendars` → list available calendars
- `POST /api/calendars/selection` → set which calendars show in UI

### Events (UI)
- `GET /api/events?from=ISO&to=ISO&calIds=...` → merged events across calendars

### Feeds
- `GET /api/feeds` → list feed configs + URLs
- `POST /api/feeds` → create feed (name + calendar IDs)
- `POST /api/feeds/:id/regenerate-token`
- `DELETE /api/feeds/:id` (disable/delete)
- `GET /ical/:token.ics` → the local iCal feed

---

## Implementation steps
### Phase 1 — Skeleton
1. Repo init:
   - `/server` (Express)
   - `/web` (React)
   - docker-compose with volumes for DB
2. Health endpoint: `/healthz`
3. Basic UI shell: navbar (Calendar / Settings)

### Phase 2 — Microsoft OAuth
1. Add MSAL Node and implement auth routes
2. Add Settings page fields for Client ID/Secret/Authority + “Test”
3. Store settings (env-first; DB fallback)
4. Confirm Graph call works: `/me` and `/me/calendars`

### Phase 3 — Calendar UI
1. Implement `/api/events` using Graph `calendarView`
2. FullCalendar on main page
3. Calendar selection UI (checkbox list)
4. Merge events and render

### Phase 4 — iCal feeds
1. Create feed configs in DB
2. Implement `/ical/:token.ics`
3. Add feed management UI + copy URL buttons
4. Add token regenerate + revoke

### Phase 5 — Hardening
1. Admin password gate for Settings/Feeds
2. Encryption-at-rest for secrets
3. Rate limit ICS endpoints
4. Better logging + error UI states

---

## Docker deliverables
### docker-compose.yml
- `app`
  - ports: `5600:5600`
  - volumes:
    - `./config:/config` (SQLite + MSAL cache)
  - env:
    - `BASE_URL=http://<host>:5600`
    - `MS_CLIENT_ID=...`
    - `MS_CLIENT_SECRET=...`
    - `MS_AUTHORITY=https://login.microsoftonline.com/consumers`
    - `ADMIN_PASSWORD=...`
    - `ENCRYPTION_KEY=...`

### Build strategy
- Prefer single container that serves:
  - API under `/api`
  - static frontend bundle
- Or two containers (server + web) if easier.

---

## Edge cases & decisions
- If “Your Family” doesn’t appear in Graph calendar list:
  - UI should explain: “This calendar may not be exposed via Microsoft Graph for this account.”
  - Still works for any calendars that do appear.
- Recurring events:
  - Using `calendarView` should return expanded instances within the window; confirm behaviour.
- Time zones:
  - Store a chosen timezone (default `Europe/Jersey`)
  - Always output ICS times consistently (UTC or TZID)

---

## Acceptance criteria
- I can sign in with Microsoft and click “Test” to confirm Graph connectivity.
- I can see a calendar UI with events from selected calendars.
- I can create a feed and copy a local URL like:
  - `http://server:3000/ical/<token>.ics`
- Another local app can subscribe to that ICS and see events.
- I can regenerate/revoke feeds without restarting the container.

---

## Useful references (for developer)
- Microsoft Graph permissions model and available scopes. :contentReference[oaicite:4]{index=4}
- Outlook/Graph calendar data location and limitations. :contentReference[oaicite:5]{index=5}
- “Your Family” calendar and lack of ICS publishing link in Outlook UI (known limitation). :contentReference[oaicite:6]{index=6}
